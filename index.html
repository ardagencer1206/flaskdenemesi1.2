<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Heterojen Filolu Çok Duruşlu Lojistik Optimizasyonu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --glass-bg: color-mix(in oklab, var(--bs-body-bg) 70%, transparent);
      --glass-bd: color-mix(in oklab, var(--bs-body-color) 15%, transparent);
    }
    body{
      background: radial-gradient(1200px 800px at 10% -10%, rgba(13,110,253,.08), transparent 40%),
                  radial-gradient(800px 800px at 120% 20%, rgba(111,66,193,.10), transparent 35%),
                  var(--bs-body-bg);
      min-height: 100dvh;
    }
    .glass{ background: var(--glass-bg); backdrop-filter: saturate(1.2) blur(6px); -webkit-backdrop-filter: saturate(1.2) blur(6px); border: 1px solid var(--glass-bd); }
    .shadow-soft{ box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    pre.code{ white-space: pre-wrap; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
    .hero{ background: linear-gradient(135deg, rgba(13,110,253,.12), rgba(111,66,193,.10)); border-bottom: 1px solid var(--bs-border-color); }
    .table thead th{ position: sticky; top: 0; z-index: 1; }
    .table-hover tbody tr:hover{ background-color: color-mix(in oklab, var(--bs-primary) 6%, transparent); }
    .btn-ghost{ background: transparent; border: 1px solid var(--bs-border-color); }
    .btn-ghost:hover{ background: color-mix(in oklab, var(--bs-primary) 10%, transparent); }
    #previewWrap .border{ border-style: dashed !important; }
    .footnote{ font-size: .875rem; color: var(--bs-secondary-color); }
    .bubble { white-space: pre-wrap; }
    .bubble.user { background: #0d6efd; color: #fff; border-radius: 1rem; padding: .5rem .75rem; margin:.25rem 0; align-self: flex-end; max-width: 90%; }
    .bubble.assistant { background: var(--bs-secondary-bg); color: var(--bs-body-color); border-radius: 1rem; padding: .5rem .75rem; margin:.25rem 0; max-width: 90%; }
    #chatBox { display: flex; flex-direction: column; gap: .25rem; }
    .accordion-button:focus{ box-shadow: none; }
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="navbar navbar-expand-md sticky-top glass shadow-soft">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <span class="badge rounded-pill text-bg-primary">Pyomo</span>
        <span class="fw-semibold">Lojistik Optimizasyonu</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-ghost" id="themeToggle" type="button" aria-label="Tema değiştir">
          <i class="bi bi-sun-fill d-none" id="iconSun"></i>
          <i class="bi bi-moon-stars-fill" id="iconMoon"></i>
        </button>
        <a class="btn btn-sm btn-primary" href="#main">Başla</a>
      </div>
    </div>
  </nav>

  <header class="hero">
    <div class="container py-5">
      <div class="row align-items-center g-4">
        <div class="col-12 col-lg-7">
          <h1 class="display-6 mb-2">Bitirmede Saplama Heterojen Filolu Çok Duruşlu Lojistik Optimizasyonu</h1>
          <p class="lead mb-0 text-secondary">
            Bu sayfa <b>dataset.json</b>’u otomatik yükler; form <b>read-only</b>’dir.
            <br/>Çöz’e basınca <b>payload gönderilmez</b>, backend sunucu tarafındaki dataset’i kullanır.
          </p>
        </div>
        <div class="col-12 col-lg-5">
          <div class="glass rounded-4 p-3 shadow-soft">
            <div class="d-flex align-items-center gap-3">
              <i class="bi bi-graph-up-arrow fs-1 text-primary"></i>
              <div>
                <div class="fw-semibold">İpucu</div>
                <div class="text-secondary small">Dataset’i güncellemek için sağ üstteki <b>Dataset’i Güncelle</b> butonuna tıklayın.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="main" class="container my-5">
    <div class="row g-4">
      <!-- Read-Only Model Girdileri -->
      <div class="col-12 col-lg-6">
        <div class="card glass shadow-soft border-0 rounded-4">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="h5 mb-0">🔧 Model Girdileri (Read-only)</h3>
              <div class="d-flex gap-2 flex-wrap">
                <a href="edit.html" class="btn btn-sm btn-warning"><i class="bi bi-pencil-square me-1"></i>Dataset’i Güncelle</a>
                <button id="reloadBtn" class="btn btn-sm btn-outline-secondary">Yeniden Yükle</button>
                <button id="downloadBtn" class="btn btn-sm btn-outline-primary">JSON’u indir</button>
              </div>
            </div>

            <div class="mb-3">
              <label for="cities" class="form-label">Şehirler (JSON dizi)</label>
              <input id="cities" class="form-control" placeholder='["İstanbul","Ankara","İzmir"]' readonly />
              <div class="form-text">Dataset’ten okunur.</div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-12 col-md-6">
                <label for="main_depot" class="form-label">Ana Depo</label>
                <input id="main_depot" class="form-control" placeholder="İstanbul" readonly />
              </div>
            </div>

            <div class="mb-3">
              <label for="vehicle_types" class="form-label">Araç Tipleri (JSON)</label>
              <textarea id="vehicle_types" class="form-control" rows="6" placeholder='{"Küçük": {...}}' readonly></textarea>
            </div>

            <div class="mb-3">
              <label for="vehicle_count" class="form-label">Araç Sayıları (JSON)</label>
              <textarea id="vehicle_count" class="form-control" rows="3" placeholder='{"Küçük": 2, "Orta": 1}' readonly></textarea>
            </div>

            <div class="mb-3">
              <label for="vehicle_initial_locations" class="form-label">Araç Konumları (JSON)</label>
              <textarea id="vehicle_initial_locations" class="form-control" rows="3" placeholder='{"Küçük_1":"Ankara","Küçük_2":"Bursa","Orta_1":"Eskişehir"}' readonly></textarea>
              <div class="form-text">Araç sayısına göre her aracın başlangıç şehri. Belirtilmeyenler varsayılan olarak ana depoda başlar.</div>
            </div>

            <div class="mb-3">
              <label for="distances" class="form-label">Mesafeler (liste; [i, j, km])</label>
              <textarea id="distances" class="form-control" rows="5" placeholder='[["İstanbul","Ankara",450], ...]' readonly></textarea>
            </div>

            <div class="mb-3">
              <label for="packages" class="form-label">Paketler (liste)</label>
              <textarea id="packages" class="form-control" rows="7" placeholder='[{"id":"P1", ...}]' readonly></textarea>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-12 col-md-6">
                <label for="minutil_penalty" class="form-label">Min. Doluluk Ceza (TL/kg)</label>
                <input id="minutil_penalty" class="form-control" type="number" step="0.01" placeholder="10.0" readonly />
              </div>
              <div class="col-12 col-md-6 d-flex align-items-end">
                <div class="d-flex gap-2 w-100 flex-wrap">
                  <button id="solveBtn" class="btn btn-primary flex-fill">Çöz (Sunucu dataset’i ile)</button>
                  <button class="btn btn-outline-secondary flex-fill" type="button"
                          data-bs-toggle="collapse" data-bs-target="#previewWrap">Önizleme</button>
                  <button
                    class="btn"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#chatWrap"
                    aria-label="Chat"
                    style="
                      --btn-bg: linear-gradient(135deg, rgba(13,110,253,.12), rgba(111,66,193,.12));
                      --btn-bd: rgba(0,0,0,.15);
                      --btn-tx: var(--bs-body-color);
                      display:inline-flex; align-items:center; gap:.5rem;
                      border:1px solid var(--btn-bd);
                      background: var(--btn-bg);
                      color: var(--btn-tx);
                      border-radius: 14px;
                      padding:.55rem .95rem;
                      font-weight: 600;
                      letter-spacing:.2px;
                      box-shadow: 0 6px 18px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.15);
                      backdrop-filter: saturate(1.15) blur(6px);
                      -webkit-backdrop-filter: saturate(1.15) blur(6px);
                      transition: transform .15s ease, box-shadow .15s ease, background .2s ease;
                    "
                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 10px 24px rgba(13,110,253,.18)'; this.style.background='linear-gradient(135deg, rgba(13,110,253,.18), rgba(111,66,193,.18))';"
                    onmouseout="this.style.transform='none'; this.style.boxShadow='0 6px 18px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.15)'; this.style.background='var(--btn-bg)';"
                  >
                    <i class="bi bi-chat-dots-fill" style="font-size:1.05rem;"></i>
                    <span>Chat</span>
                  </button>
                </div>
              </div>
            </div>

            <div id="status" class="text-secondary small"></div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="col-12 col-lg-6">
        <div class="card glass shadow-soft border-0 rounded-4">
          <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <h3 class="h5 mb-0">📈 Sonuçlar</h3>
              <span class="badge rounded-pill text-bg-info-subtle text-info-emphasis">Canlı</span>
            </div>
            <div id="results" class="text-secondary">Henüz çözüm yok. Dataset ile çözmek için <b>Çöz</b>’e basın.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tips & Preview -->
    <div class="card glass shadow-soft border-0 rounded-4 mt-4">
      <div class="card-body p-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h3 class="h6 mb-0">ℹ️ JSON İpuçları</h3>
          <span class="badge text-bg-light">Form read-only; düzenlemek için “Dataset’i Güncelle”</span>
        </div>
        <ul class="text-secondary mb-3">
          <li>“Dataset’i Güncelle” ile <code>edit.html</code>’de düzenleyip sunucudaki <code>dataset.json</code>’u kaydedin.</li>
          <li>Bu sayfa dataset’i otomatik yeniden yükler (Yeniden Yükle butonuyla da çağırabilirsiniz).</li>
          <li><code>vehicle_initial_locations</code> ile her araç için başlangıç şehri verebilirsiniz. Belirtilmeyenler ana depoda başlar.</li>
        </ul>

        <!-- Preview Collapse -->
        <div class="collapse" id="previewWrap">
          <div class="border rounded-4 p-3 bg-body-tertiary">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="fw-semibold">Mevcut Dataset (önizleme)</span>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshPreview()">Yenile</button>
            </div>
            <pre class="code bg-dark text-light rounded p-3 mb-0" id="preview"></pre>
          </div>
        </div>

        <!-- Chat Collapse -->
        <div class="collapse mt-3" id="chatWrap">
          <div class="border rounded-4 p-3 bg-body-tertiary">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="fw-semibold">Chat (Parametre Asistanı)</span>
              <span class="badge text-bg-light">VRP Assistant 1.0</span>
            </div>

            <div id="chatBox" class="chat-box border rounded p-2"
                 style="max-height: 360px; overflow:auto; background: var(--bs-body-bg);">
              <div id="chatMessages" class="small text-secondary">
                Dataset’e göre sorular sorabilirsiniz. Örn: “P1 zamanında yetişiyor mu?”
              </div>
            </div>

            <div class="input-group mt-2">
              <input id="chatInput" class="form-control" placeholder="Soru yazın… (örn: 'Min. doluluk hedefi ne?')" />
              <button id="chatSend" class="btn btn-dark" type="button">Gönder</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <p class="mt-3 footnote"> TOBB ETÜ Endüstri <code>/solve</code> Bitirme Team</p>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  const $  = (id) => document.getElementById(id);
  const $$ = (sel) => document.querySelector(sel);

  function safeHideCollapse(id){
    const el = $(id); if (!el) return;
    try { if (el.classList.contains("show")) bootstrap.Collapse.getOrCreateInstance(el).hide(); } catch(_){}
  }

  function fmtTL(x){
    const v = Number.isFinite(x) ? x : 0;
    return (Math.round(v*100)/100).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}) + " TL";
  }
  const n2 = (x)=> Number.isFinite(x) ? (Math.round(x*100)/100).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}) : "—";

  function parseJSON(id){ try{ return JSON.parse($(id).value); }catch(_){ return null; } }

  // Mesafe & hız yardımcıları (önizlemeye yüklenen dataset’ten)
  function getDistanceKm(i,j){
    const d = parseJSON("distances") || [];
    for(const [a,b,km] of d){ if((a===i && b===j) || (a===j && b===i)) return +km; }
    return null;
  }
  function getVehicleSpeed(vehicle){
    const vt = parseJSON("vehicle_types") || {};
    const typ = (vehicle||"").split("_")[0];
    return vt[typ]?.hiz_kmh ?? null;
  }

  function buildReadOnlyJSON(){
    // read-only alanlar dataset’ten dolduruldu; burada sadece önizleme/chat için JSON yapıyoruz
    const parse = (id, name) => { try{ return JSON.parse($(id).value); }catch(e){ throw new Error(name+" JSON değil: "+e.message); } };
    return {
      cities: parse("cities","Şehirler"),
      main_depot: $("main_depot").value.trim(),
      vehicle_types: parse("vehicle_types","Araç Tipleri"),
      vehicle_count: parse("vehicle_count","Araç Sayıları"),
      vehicle_initial_locations: parse("vehicle_initial_locations","Araç Konumları"),
      distances: parse("distances","Mesafeler"),
      packages: parse("packages","Paketler"),
      minutil_penalty: parseFloat($("minutil_penalty").value)
    };
  }

  function renderPackageTimelines(r){
    // r.packages[*].route bekleniyor; yoksa geç
    const pkgs = r.packages || [];
    if(!pkgs.length) return "";

    let html = `<h6 class="mt-4 mb-2">Paket Zaman Çizelgeleri</h6>
    <div class="accordion" id="pkgAccordion">`;

    pkgs.forEach((p,idx)=>{
      const rid = `pkgitem_${idx}`;
      const route = Array.isArray(p.route) ? p.route : [];
      if(!route.length) return;

      // satırlar
      let rows = "";
      route.forEach((step, i)=>{
        const from = step.from || step.i || "—";
        const to   = step.to   || step.j || "—";
        const veh  = step.vehicle || "—";
        const km   = step.km ?? getDistanceKm(from,to);
        const durH = step.duration_h ?? step.travel_time_h ?? (()=>{
          const v = getVehicleSpeed(veh);
          return (Number.isFinite(km) && Number.isFinite(v) && v>0) ? (km / v) : null;
        })();

        rows += `<tr>
          <td class="text-center">${i+1}</td>
          <td>${veh}</td>
          <td>${from} → ${to}</td>
          <td>${Number.isFinite(km)? (km.toLocaleString("tr-TR"))+" km" : "—"}</td>
          <td>${Number.isFinite(durH)? n2(durH)+" saat" : "—"}</td>
        </tr>`;
      });

      html += `
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${rid}">
            <span class="me-2 badge text-bg-secondary">${p.id}</span>
            <span class="me-2">${p.origin||p.baslangic} → ${p.dest||p.hedef}</span>
            <span class="small text-secondary">| Teslim: ${p.delivered_at ?? "—"}${(p.on_time===false)?" (gecikmeli)":""}</span>
          </button>
        </h2>
        <div id="${rid}" class="accordion-collapse collapse" data-bs-parent="#pkgAccordion">
          <div class="accordion-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr><th style="width:1%" class="text-center">#</th><th>Araç</th><th>Güzergâh</th><th>Mesafe</th><th>Süre (saat)</th></tr>
                </thead>
                <tbody>${rows || `<tr><td colspan="5" class="text-secondary">Rota bilgisi yok.</td></tr>`}</tbody>
              </table>
            </div>
          </div>
        </div>
      </div>`;
    });

    html += `</div>`;
    return html;
  }

  function renderResults(resp){
    const el = $("results");
    if(!resp || resp.ok === false){
      el.innerHTML = `<div class="alert alert-warning mb-0" role="alert">${(resp && resp.error) ? resp.error : "Bilinmeyen hata"}</div>`;
      return;
    }
    const r = resp.result || {};
    let html = "";
    html += `<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
      <span class="badge rounded-pill text-bg-primary">Çözücü: ${resp.solver}</span>
      <span class="badge rounded-pill text-bg-success">Amaç: ${fmtTL(r.objective)}</span>
    </div>`;
    const cb = r.cost_breakdown || {};
    html += `<h6 class="mt-2">Maliyet Dağılımı</h6>
      <div class="table-responsive"><table class="table table-sm table-hover align-middle mb-3">
        <thead class="table-light"><tr><th>Kalem</th><th>Tutar</th></tr></thead>
        <tbody>
          <tr><td>Taşıma</td><td>${fmtTL(cb.transport)}</td></tr>
          <tr><td>Sabit</td><td>${fmtTL(cb.fixed)}</td></tr>
          <tr><td>Gecikme</td><td>${fmtTL(cb.lateness)}</td></tr>
          <tr><td>Min. doluluk açığı</td><td>${fmtTL(cb.min_util_gap)}</td></tr>
        </tbody></table></div>`;
    if ((r.vehicle_routes||[]).length){
      html += `<h6>Araç Rotaları</h6>`;
      r.vehicle_routes.forEach(vr=>{
        html += `<div class="border rounded-3 p-2 mb-2">
          <div class="fw-semibold">${vr.vehicle} <span class="text-secondary fw-normal">(Kapasite: ${vr.capacity} kg)</span></div>
          <div class="table-responsive"><table class="table table-sm table-hover mb-0">
          <thead class="table-light"><tr><th>Rota</th><th>Mesafe</th><th>Süre (saat)</th><th>Yük</th><th>Doluluk</th><th>Paketler</th></tr></thead><tbody>`;
        (vr.legs||[]).forEach(l=>{
          const duration = (Number.isFinite(l.duration_h)? n2(l.duration_h)+" s": "—");
          html += `<tr><td>${l.from} → ${l.to}</td><td>${(l.km??0).toLocaleString("tr-TR")} km</td><td>${duration}</td><td>${Math.round(l.load_kg)} kg</td><td>${(l.utilization_pct||0).toFixed(1)}%</td><td>${(l.packages||[]).length?l.packages.join(", "):"—"}</td></tr>`;
        });
        html += `</tbody></table></div></div>`;
      });
    }
    if ((r.packages||[]).length){
      html += `<h6 class="mt-3">Paketler</h6>
      <div class="table-responsive"><table class="table table-sm table-hover align-middle">
      <thead class="table-light"><tr><th>ID</th><th>Güzergâh</th><th>Hazır</th><th>Termin (saat)</th><th>Teslim (saat)</th><th>Durum</th><th>Ceza</th></tr></thead><tbody>`;
      r.packages.forEach(p=>{
        const delivered = (p.delivered_at!==null && p.delivered_at!==undefined);
        html += `<tr><td><b>${p.id}</b></td><td>${p.origin||p.baslangic} → ${p.dest||p.hedef}</td><td>${p.ready ?? p.ready_hour ?? 0}</td><td>${p.deadline_by ?? p.deadline_hour ?? "—"}</td><td>${delivered? p.delivered_at : "—"}</td><td>${delivered? (p.on_time? "✅ Zamanında":"⚠️ Gecikmeli") : "❌ Teslim yok"}</td><td>${fmtTL(p.lateness_penalty||0)}</td></tr>`;
      });
      html += `</tbody></table></div>`;
      // yeni: paket zaman çizelgeleri (akordeon)
      html += renderPackageTimelines(r);
    }
    el.innerHTML = html;
  }

  function setStatus(msg, type="secondary"){ const s = $("status"); if (s) s.innerHTML = `<span class="text-${type}">${msg}</span>`; }
  function setResultsInfo(msg, type="info"){ const r = $("results"); if (r) r.innerHTML = `<div class="alert alert-${type}">${msg}</div>`; }

  async function loadDataset(){
    setStatus("Dataset yükleniyor…");
    let data;
    try{
      let res = await fetch("/dataset", { cache: "no-store" });
      if(res.ok){ const js = await res.json(); if(js && js.ok && js.dataset) data = js.dataset; }
      if(!data){
        const res2 = await fetch(`/dataset.json?v=${Date.now()}`, { cache: "no-store" });
        if(!res2.ok) throw new Error("dataset.json okunamadı");
        data = await res2.json();
      }
      $("cities").value = JSON.stringify(data.cities ?? [],  null, 0);
      $("main_depot").value = data.main_depot ?? "";
      $("vehicle_types").value = JSON.stringify(data.vehicle_types ?? {}, null, 2);
      $("vehicle_count").value = JSON.stringify(data.vehicle_count ?? {}, null, 2);
      $("vehicle_initial_locations").value = JSON.stringify(data.vehicle_initial_locations ?? {}, null, 2);
      $("distances").value = JSON.stringify(data.distances ?? [], null, 2);
      $("packages").value = JSON.stringify(data.packages ?? [], null, 2);
      $("minutil_penalty").value = (data.minutil_penalty ?? 10).toString();
      refreshPreview();
      setStatus("Dataset yüklendi ✔️", "success");
    }catch(err){
      console.error(err);
      setStatus("Dataset yüklenemedi: " + err.message, "danger");
    }
  }

  async function runSolveUsingServerDataset(){
    const res  = await fetch("/solve?use_dataset=1", { method:"POST", headers:{ "Content-Type":"application/json" }, body:"{}" });
    const raw  = await res.text();
    if(!(res.headers.get("content-type")||"").includes("application/json")) throw new Error("Sunucudan JSON yerine HTML/metin geldi: " + raw.slice(0,300));
    const data = JSON.parse(raw);
    if (!res.ok || data.ok === false) throw new Error(data.error || raw.slice(0,300) || ("HTTP " + res.status));
    return data;
  }

  $("solveBtn")?.addEventListener("click", async ()=>{
    safeHideCollapse("previewWrap"); safeHideCollapse("chatWrap");
    const btn  = $("solveBtn"); btn && (btn.disabled = true);
    setStatus("Çözülüyor… (sunucu dataset’i ile)"); setResultsInfo("Sunucuya istek gönderildi…", "info");
    try{ const data = await runSolveUsingServerDataset(); renderResults(data); setStatus("Tamamlandı ✔️", "success"); }
    catch(err){ console.error(err); setResultsInfo("Hata: " + (err.message||err), "danger"); setStatus("Hata oluştu", "danger"); }
    finally{ btn && (btn.disabled = false); }
  });

  function refreshPreview(){ try{ $("preview").textContent = JSON.stringify(buildReadOnlyJSON(), null, 2); }catch(e){ $("preview").textContent = "Önizleme derlenemedi:\n"+e.message; } }

  $("downloadBtn")?.addEventListener("click", async ()=>{
    try{
      const json = JSON.stringify(buildReadOnlyJSON(), null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url; a.download = "dataset.json"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      setStatus("JSON indirildi (dataset.json).", "success");
    }catch(e){ setStatus("JSON indirilemedi: " + e.message, "danger"); }
  });

  $("reloadBtn")?.addEventListener("click", loadDataset);

  (function(){
    const html=document.documentElement, toggle=$("themeToggle"), iconSun=$("iconSun"), iconMoon=$("iconMoon");
    function apply(theme){ html.setAttribute('data-bs-theme', theme); const isLight=(theme==='light'); iconSun&&iconSun.classList.toggle('d-none',!isLight); iconMoon&&iconMoon.classList.toggle('d-none',isLight); try{localStorage.setItem('ui-theme',theme);}catch(_){}} 
    const saved = (()=>{ try{ return localStorage.getItem('ui-theme'); }catch(_){ return null; } })();
    apply(saved||'light');
    toggle?.addEventListener('click', ()=>{ apply(html.getAttribute('data-bs-theme')==='light'?'dark':'light'); });
  })();

  // Chat (dataset bağlamı)
  const chatState = { messages: [] };
  function pushChat(role, content){
    chatState.messages.push({ role, content });
    const area = $("chatMessages"); if (!area) return;
    const div  = document.createElement("div"); div.className = "bubble " + (role==="user"?"user":"assistant"); div.textContent = content; area.appendChild(div);
    const box = $("chatBox"); if (box) box.scrollTop = box.scrollHeight + 999;
  }
  async function sendChat(){
    const input = $("chatInput"); if (!input) return;
    const text = (input.value||"").trim(); if(!text) return;
    input.value=""; pushChat("user", text);
    let context={}; try{ context = buildReadOnlyJSON(); }catch(_){}
    try{
      const res = await fetch("/chat", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ messages: chatState.messages, context }) });
      const raw = await res.text(); if(!(res.headers.get("content-type")||"").includes("application/json")) throw new Error("Sunucudan JSON yerine HTML/metin geldi: "+raw.slice(0,200));
      const data = JSON.parse(raw); if(!res.ok || data.ok===false){ pushChat("assistant","⚠️ "+(data.error||"Sunucu hatası")); return; }
      pushChat("assistant", data.answer || "(yanıt boş)");
    }catch(err){ console.error(err); pushChat("assistant","⚠️ İstek sırasında hata: "+err.message); }
  }
  $("chatSend")?.addEventListener("click", sendChat);
  $("chatInput")?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendChat(); });

  $$('[data-bs-target="#previewWrap"]')?.addEventListener("click", ()=> safeHideCollapse("chatWrap"));
  $$('[data-bs-target="#chatWrap"]')?.addEventListener("click", ()=> safeHideCollapse("previewWrap"));

  // İlk yüklemede dataset’i çek
  loadDataset();
  </script>
</body>
</html>
